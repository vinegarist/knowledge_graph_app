# 症状诊断功能修复说明

## 问题描述

用户提问"我有点感冒，发烧，流鼻涕，可能是什么病？"时，AI无法识别这是一个症状诊断查询，而是将其作为普通查询处理，导致无法找到相关信息。

## 问题原因

1. **缺乏症状诊断识别**：AI没有识别症状描述查询的能力
2. **症状关键词提取不足**：无法从自然语言中提取症状关键词
3. **症状-疾病映射缺失**：没有建立症状到疾病的映射关系
4. **搜索策略不匹配**：使用通用搜索而不是症状诊断搜索

## 修复内容

### 1. 症状诊断查询识别

#### 诊断关键词识别
```python
diagnosis_keywords = [
    '可能是什么病', '什么病', '诊断', '什么原因', '怎么回事',
    '我有点', '我有', '我出现', '我得了', '我患了',
    '症状', '表现', '征兆', '感觉', '不适'
]
```

#### 症状关键词识别
```python
symptom_keywords = [
    '感冒', '发烧', '发热', '咳嗽', '头痛', '头疼', '流鼻涕', '鼻塞',
    '喉咙痛', '咽痛', '嗓子疼', '打喷嚏', '乏力', '疲劳', '食欲不振',
    '恶心', '呕吐', '腹泻', '腹痛', '腹胀', '便秘', '失眠', '多梦',
    '心悸', '胸闷', '气短', '呼吸困难', '胸痛', '背痛', '关节痛',
    '肌肉酸痛', '皮疹', '瘙痒', '红肿', '水肿', '头晕', '眩晕',
    '耳鸣', '视力模糊', '眼痛', '眼红', '流泪', '口干', '口苦',
    '口臭', '牙龈出血', '牙痛', '口腔溃疡', '声音嘶哑', '失声'
]
```

### 2. 症状提取功能

#### 症状映射表
```python
symptom_mapping = {
    '感冒': ['感冒', '上呼吸道感染'],
    '发烧': ['发烧', '发热', '体温升高'],
    '咳嗽': ['咳嗽', '咳痰', '干咳'],
    '头痛': ['头痛', '头疼', '偏头痛'],
    '流鼻涕': ['流鼻涕', '鼻涕', '鼻塞'],
    '喉咙痛': ['喉咙痛', '咽痛', '嗓子疼'],
    '打喷嚏': ['打喷嚏', '喷嚏'],
    '乏力': ['乏力', '疲劳', '无力'],
    '食欲不振': ['食欲不振', '不想吃饭', '没胃口'],
    '恶心': ['恶心', '想吐'],
    '呕吐': ['呕吐', '吐'],
    '腹泻': ['腹泻', '拉肚子'],
    '腹痛': ['腹痛', '肚子疼'],
    '腹胀': ['腹胀', '肚子胀'],
    '便秘': ['便秘', '大便干燥'],
    '失眠': ['失眠', '睡不着'],
    '心悸': ['心悸', '心跳快'],
    '胸闷': ['胸闷', '胸口闷'],
    '气短': ['气短', '呼吸困难'],
    '胸痛': ['胸痛', '胸口疼'],
    '背痛': ['背痛', '后背疼'],
    '关节痛': ['关节痛', '关节疼'],
    '肌肉酸痛': ['肌肉酸痛', '肌肉疼'],
    '皮疹': ['皮疹', '红疹'],
    '瘙痒': ['瘙痒', '痒'],
    '红肿': ['红肿', '红'],
    '水肿': ['水肿', '肿'],
    '头晕': ['头晕', '晕'],
    '眩晕': ['眩晕', '天旋地转'],
    '耳鸣': ['耳鸣', '耳朵响'],
    '视力模糊': ['视力模糊', '看不清'],
    '眼痛': ['眼痛', '眼睛疼'],
    '眼红': ['眼红', '眼睛红'],
    '流泪': ['流泪', '眼泪'],
    '口干': ['口干', '嘴巴干'],
    '口苦': ['口苦', '嘴巴苦'],
    '口臭': ['口臭', '口气'],
    '牙龈出血': ['牙龈出血', '牙龈'],
    '牙痛': ['牙痛', '牙齿疼'],
    '口腔溃疡': ['口腔溃疡', '溃疡'],
    '声音嘶哑': ['声音嘶哑', '嘶哑'],
    '失声': ['失声', '说不出话']
}
```

### 3. 症状诊断搜索算法

#### 搜索策略
1. **症状-疾病匹配**：根据症状关键词搜索相关疾病
2. **症状实体匹配**：搜索症状相关的实体
3. **降级搜索**：如果缓存不可用，使用备用搜索

#### 搜索流程
```python
def _search_by_symptoms(self, symptoms: List[str], limit: int = 10):
    # 1. 通过症状关键词搜索相关疾病
    for symptom in symptoms:
        for node in cached_graph.get('nodes', []):
            if (symptom in node_label and 
                any(disease_keyword in node_label for disease_keyword in disease_keywords)):
                # 找到疾病实体
                
    # 2. 搜索症状相关的实体
    if len(results) < limit:
        for symptom in symptoms:
            for node in cached_graph.get('nodes', []):
                if symptom in node_label:
                    # 找到症状实体
```

### 4. 查询意图解析增强

#### 新增诊断意图
```python
'diagnosis': {
    'keywords': ['可能是什么病', '什么病', '诊断', '什么原因', '怎么回事'],
    'relation': '症状',
    'target_type': 'diagnosis'
}
```

#### 症状诊断识别
```python
def _is_symptom_diagnosis_query(self, query_lower: str) -> bool:
    has_diagnosis_keyword = any(keyword in query_lower for keyword in diagnosis_keywords)
    has_symptom_keyword = any(keyword in query_lower for keyword in symptom_keywords)
    return has_diagnosis_keyword and has_symptom_keyword
```

## 使用示例

### 查询："我有点感冒，发烧，流鼻涕，可能是什么病？"

1. **意图识别**：
   - 检测到诊断关键词：`可能是什么病`
   - 检测到症状关键词：`感冒`、`发烧`、`流鼻涕`
   - 识别为症状诊断查询

2. **症状提取**：
   - 提取症状：`['感冒', '发烧', '流鼻涕']`

3. **症状搜索**：
   - 搜索包含这些症状的疾病实体
   - 返回相关的疾病信息

4. **结果**：
   - 找到感冒相关的疾病实体
   - 显示症状匹配信息
   - 提供可能的诊断建议

### 查询："我有咳嗽，喉咙痛，可能是什么病？"

1. **意图识别**：
   - 检测到诊断关键词：`可能是什么病`
   - 检测到症状关键词：`咳嗽`、`喉咙痛`
   - 识别为症状诊断查询

2. **症状提取**：
   - 提取症状：`['咳嗽', '喉咙痛']`

3. **症状搜索**：
   - 搜索包含这些症状的疾病实体
   - 返回相关的疾病信息

## 测试方法

### 1. 运行症状诊断测试
```bash
python test_symptom_diagnosis.py
```

### 2. 测试用例

#### 感冒相关症状
- "我有点感冒，发烧，流鼻涕，可能是什么病？"
- "我有感冒症状，发烧，咳嗽，可能是什么病？"
- "我出现感冒，头痛，乏力，可能是什么病？"

#### 发烧相关症状
- "我发烧了，头痛，全身酸痛，可能是什么病？"
- "我有发烧，咳嗽，胸闷，可能是什么病？"
- "我出现发烧，流鼻涕，打喷嚏，可能是什么病？"

#### 咳嗽相关症状
- "我咳嗽，喉咙痛，可能是什么病？"
- "我有咳嗽，胸闷，气短，可能是什么病？"
- "我出现咳嗽，发烧，乏力，可能是什么病？"

#### 头痛相关症状
- "我头痛，恶心，可能是什么病？"
- "我有头痛，发烧，可能是什么病？"
- "我出现头痛，头晕，可能是什么病？"

#### 消化系统症状
- "我腹痛，恶心，呕吐，可能是什么病？"
- "我有腹泻，腹痛，可能是什么病？"
- "我出现腹胀，食欲不振，可能是什么病？"

#### 其他症状
- "我失眠，多梦，可能是什么病？"
- "我有心悸，胸闷，可能是什么病？"
- "我出现皮疹，瘙痒，可能是什么病？"

## 预期结果

### 症状诊断查询
- 正确识别症状诊断意图
- 提取症状关键词
- 找到相关的疾病实体
- 显示症状匹配信息
- 提供诊断建议

### 非症状诊断查询
- 使用原有的搜索策略
- 保持原有功能
- 提供相关信息

## 技术细节

### 查询意图结构
```python
{
    'original_query': '我有点感冒，发烧，流鼻涕，可能是什么病？',
    'intent': 'diagnosis',
    'disease': '感冒',
    'relation': '症状',
    'target_type': 'diagnosis',
    'is_structured_query': True,
    'is_symptom_diagnosis': True,
    'symptoms': ['感冒', '发烧', '流鼻涕']
}
```

### 症状诊断搜索结果
```python
{
    'id': 'D001',
    'label': '感冒[疾病]',
    'match_type': 'symptom_diagnosis',
    'match_score': 85,
    'matched_symptoms': ['感冒', '发烧', '流鼻涕'],
    'search_method': 'symptom_disease_match'
}
```

## 注意事项

1. **症状识别**：当前支持常见症状，可以扩展症状词典
2. **疾病匹配**：使用关键词匹配，支持部分匹配
3. **缓存支持**：优先使用缓存系统，提高搜索性能
4. **调试信息**：添加详细的调试信息，便于问题排查

## 后续优化建议

1. **扩展症状词典**：添加更多症状名称和同义词
2. **改进症状匹配**：使用更精确的症状匹配算法
3. **添加机器学习**：使用NLP技术改进症状识别
4. **支持复杂症状**：支持症状组合和症状严重程度
5. **添加症状权重**：根据症状重要性进行加权匹配
6. **支持症状时间**：考虑症状出现的时间和持续时间

## 总结

通过添加症状诊断功能，AI现在能够：

- **识别症状描述查询**：自动识别用户的症状描述
- **提取症状关键词**：从自然语言中提取症状信息
- **搜索相关疾病**：根据症状找到可能的疾病
- **提供诊断建议**：基于症状提供初步诊断建议

这些功能确保了系统能够处理用户的各种症状描述查询，为用户提供更智能的医疗信息检索服务。 
# AI查询理解功能修复说明

## 问题描述

用户提问"感冒应该吃什么？"时，AI没有正确理解查询意图，没有按照"疾病-关系-目标"的模式搜索，而是进行了通用的实体搜索，导致无法找到相关的饮食建议。

## 问题原因

1. **缺乏查询意图理解**：AI没有解析用户的具体查询意图
2. **搜索模式单一**：只进行通用的实体匹配，没有考虑关系搜索
3. **没有结构化查询**：没有按照"疾病-关系-目标"的模式进行搜索

## 修复内容

### 1. 添加查询意图解析

新增`_parse_query_intent`方法，能够识别以下查询模式：

#### 饮食相关查询
- 关键词：`吃什么`、`饮食`、`食物`、`菜`、`汤`、`粥`、`水果`、`蔬菜`、`营养`
- 关系：`推荐食谱`
- 目标类型：`food`

#### 药物相关查询
- 关键词：`吃什么药`、`药物`、`药品`、`药`、`治疗`、`用药`、`处方`
- 关系：`常用药品`
- 目标类型：`medicine`

#### 症状相关查询
- 关键词：`症状`、`表现`、`征兆`、`感觉`、`不适`
- 关系：`症状`
- 目标类型：`symptom`

#### 检查相关查询
- 关键词：`检查`、`化验`、`检测`、`诊断`、`筛查`
- 关系：`检查项目`
- 目标类型：`examination`

#### 预防相关查询
- 关键词：`预防`、`避免`、`防止`、`预防措施`
- 关系：`预防措施`
- 目标类型：`prevention`

#### 并发症相关查询
- 关键词：`并发症`、`后果`、`影响`、`恶化`
- 关系：`并发症`
- 目标类型：`complication`

### 2. 添加关系搜索功能

新增`_search_by_relation`方法，能够：

- 根据疾病名称查找相关实体
- 根据关系类型查找相关连接
- 返回目标实体及其关系信息
- 支持灵活的关系匹配

### 3. 改进搜索逻辑

修改`ask`方法，实现智能搜索：

```python
# 解析查询意图
query_intent = self._parse_query_intent(question)

# 根据意图和疾病搜索相关实体
if query_intent['is_structured_query']:
    # 结构化查询：使用关系搜索
    related_entities = self._search_by_relation(
        query_intent['disease'], 
        query_intent['relation'], 
        limit=8
    )
else:
    # 非结构化查询：使用通用搜索
    related_entities = self.search_entities(question, limit=8)
```

## 使用示例

### 查询："感冒应该吃什么？"

1. **意图解析**：
   - 检测到关键词：`吃什么` → 饮食意图
   - 检测到疾病：`感冒`
   - 关系：`推荐食谱`

2. **关系搜索**：
   - 查找疾病实体：`感冒[疾病]`
   - 查找关系：`推荐食谱`
   - 返回目标实体：相关的食物/食谱

3. **结果**：
   - 找到相关的饮食建议实体
   - 显示关系信息：`推荐食谱`
   - 来源疾病：`感冒[疾病]`

### 查询："感冒吃什么药？"

1. **意图解析**：
   - 检测到关键词：`吃什么药` → 药物意图
   - 检测到疾病：`感冒`
   - 关系：`常用药品`

2. **关系搜索**：
   - 查找疾病实体：`感冒[疾病]`
   - 查找关系：`常用药品`
   - 返回目标实体：相关的药物

## 测试方法

### 1. 运行测试脚本
```bash
python test_query_understanding.py
```

### 2. 测试用例

#### 饮食相关
- "感冒应该吃什么？"
- "感冒吃什么食物好？"
- "感冒的饮食建议"

#### 药物相关
- "感冒吃什么药？"
- "感冒用什么药物治疗？"
- "感冒的用药建议"

#### 症状相关
- "感冒有什么症状？"
- "感冒的表现有哪些？"
- "感冒的征兆"

#### 检查相关
- "感冒需要做什么检查？"
- "感冒的检查项目"
- "感冒的诊断方法"

#### 预防相关
- "如何预防感冒？"
- "感冒的预防措施"
- "避免感冒的方法"

#### 并发症相关
- "感冒的并发症有哪些？"
- "感冒会有什么后果？"
- "感冒的影响"

## 预期结果

### 结构化查询
- 正确识别查询意图
- 找到相关的目标实体
- 显示关系信息
- 提供准确的回答

### 非结构化查询
- 使用通用搜索
- 保持原有功能
- 提供相关信息

## 技术细节

### 查询意图结构
```python
{
    'original_query': '感冒应该吃什么？',
    'intent': 'diet',
    'disease': '感冒',
    'relation': '推荐食谱',
    'target_type': 'food',
    'is_structured_query': True
}
```

### 关系搜索结果
```python
{
    'id': 'F001',
    'label': '姜汤',
    'match_type': 'relation',
    'match_score': 90,
    'relation': '推荐食谱',
    'source_disease': '感冒[疾病]',
    'edge_id': 'E123'
}
```

## 注意事项

1. **疾病识别**：当前支持常见疾病名称，可以扩展疾病词典
2. **关系匹配**：使用灵活匹配，支持部分匹配和关键词匹配
3. **缓存支持**：优先使用缓存系统，提高搜索性能
4. **调试信息**：添加详细的调试信息，便于问题排查

## 后续优化建议

1. **扩展疾病词典**：添加更多疾病名称和同义词
2. **改进关系匹配**：使用更精确的关系匹配算法
3. **添加机器学习**：使用NLP技术改进意图识别
4. **支持复杂查询**：支持多疾病、多关系的复杂查询 